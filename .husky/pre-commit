#!/bin/sh

# Format files and re-stage any formatted changes
echo "âœ¨ Formatting code..."
STAGED_FILES=$(git diff --cached --name-only)
if ! trunk fmt >/dev/null 2>&1; then
	echo "âŒ Code formatting failed. Run 'trunk fmt' to see details."
	exit 1
fi
if [ -n "${STAGED_FILES}" ]; then
	# Filter out deleted files before adding
	echo "${STAGED_FILES}" | xargs -I {} sh -c 'test -f "{}" && git add "{}"'
fi

# Run linter with auto-fix and re-stage any fixes
echo "ğŸ” Running linter checks..."
if ! trunk check --fix >/dev/null 2>&1; then
	echo "âŒ Linting failed. Run 'trunk check' to see errors and fix them."
	exit 1
fi
# Recapture staged files after trunk check --fix may have modified additional files
STAGED_FILES=$(git diff --cached --name-only)
if [ -n "${STAGED_FILES}" ]; then
	# Filter out deleted files before adding
	echo "${STAGED_FILES}" | xargs -I {} sh -c 'test -f "{}" && git add "{}"'
fi

# Run type and Svelte checks to catch TS/Svelte typing regressions
# echo "ğŸ§ª Running svelte-check..."
# if ! npm run -s check >/dev/null 2>&1; then
# 	echo "âŒ Type/Svelte checks failed. Run 'npm run check' to see details."
# 	exit 1
# fi

echo "âœ… All pre-commit checks passed!"
