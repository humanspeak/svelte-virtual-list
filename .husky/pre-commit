#!/bin/sh

set -eu

# Resolve trunk binary and skip if missing (avoid platform-specific PATH assumptions)
TRUNK_BIN=$(command -v trunk 2>/dev/null || true)
if [ -z "${TRUNK_BIN}" ]; then
	echo "âš ï¸  'trunk' CLI not found; skipping formatting and lint checks."
	echo "   Install with 'brew install trunk-io' or see https://docs.trunk.io for setup."
	exit 0
fi

# Format files and re-stage any formatted changes
echo "âœ¨ Formatting code..."
if ! "${TRUNK_BIN}" fmt >/dev/null 2>&1; then
	echo "âŒ Code formatting failed. Run 'trunk fmt' to see details."
	exit 1
fi
# Restage modified tracked files after formatting
git add -u

# Run linter with auto-fix and re-stage any fixes
echo "ğŸ” Running linter checks..."
if ! "${TRUNK_BIN}" check --fix >/dev/null 2>&1; then
	echo "âŒ Linting failed. Run 'trunk check' to see errors and fix them."
	exit 1
fi
# Restage modified tracked files after auto-fixes
git add -u

# Run type and Svelte checks to catch TS/Svelte typing regressions
echo "ğŸ§ª Running svelte-check..."
if ! npm run -s check >/dev/null 2>&1; then
	echo "âŒ Type/Svelte checks failed. Run 'npm run check' to see details."
	exit 1
fi

echo "âœ… All pre-commit checks passed!"
